# docker-compose-local.yml (로컬 개발용 - Backend + Frontend만)
# AI 서버는 brickers-ai/docker-compose-local.yml로 별도 실행
# 사용법: docker compose -f docker-compose-local.yml up --build

services:
  # ============================================
  # 1. Backend (Spring Boot)
  # ============================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: brickers-backend:local
    container_name: brickers-backend-local
    restart: "no"
    ports:
      - "8080:8080"
    environment:
      - TZ=Asia/Seoul
      # MongoDB (로컬 테스트용 Atlas)
      - PRIMARY_MONGODB_URI=${PRIMARY_MONGODB_URI}
      # AWS S3
      - AWS_S3_BUCKET=${AWS_S3_BUCKET}
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - UPLOAD_PROVIDER=S3
      - UPLOAD_PUBLIC_BASE_URL=https://${AWS_S3_BUCKET}.s3.${AWS_REGION}.amazonaws.com
      # JWT
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_EXPIRATION=${JWT_ACCESS_EXPIRATION}
      - JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION}
      # OAuth
      - KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
      - KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}
      - KAKAO_ADMIN_KEY=${KAKAO_ADMIN_KEY}
      - KAKAO_REDIRECT_URI=http://localhost:8080/auth/kakao/callback
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URI=http://localhost:3000/oauth/callback/google
      - GOOGLE_LOCAL_REDIRECT_URI=http://localhost:8080/oauth/callback/google
      # Cookie (로컬은 HTTP이므로 Secure=false)
      - COOKIE_SECURE=false
      - COOKIE_SAMESITE=Lax
      # Base URLs
      - FRONT_BASE_URL=http://localhost:3000
      # AI Server (별도 실행 - host.docker.internal로 접근)
      - AI_SERVER_URL=${AI_SERVER_URL:-http://host.docker.internal:8000}
      # OpenAI
      - APP_OPENAI_API_KEY=${APP_OPENAI_API_KEY:-sk-dummy}
      # SQS (로컬 전용 큐)
      - AWS_SQS_ENABLED=true
      - AWS_SQS_REQUEST_QUEUE_URL=https://sqs.ap-northeast-2.amazonaws.com/381328847032/brickers-request-queue-local
      - AWS_SQS_RESULT_QUEUE_URL=https://sqs.ap-northeast-2.amazonaws.com/381328847032/brickers-result-queue-local
      # Gallery Revalidate
      - GALLERY_REVALIDATE_ENABLED=true
      - GALLERY_REVALIDATE_URL=http://frontend:3000/api/revalidate
      - GALLERY_REVALIDATE_SECRET=local-secret
    networks:
      - brickers-local

  # ============================================
  # 2. Frontend (Next.js - Gallery App)
  # ============================================
  frontend:
    build:
      context: ./gallery-app
      dockerfile: Dockerfile
    image: brickers-frontend:local
    container_name: brickers-frontend-local
    restart: "no"
    ports:
      - "3000:3000"
    environment:
      - TZ=Asia/Seoul
      - NODE_ENV=production
      # Next.js - 클라이언트에서 상대경로 사용
      - NEXT_PUBLIC_API_BASE_URL=http://backend:8080
      # Next.js - SSR에서 Docker 내부 네트워크 사용
      - API_BASE=http://backend:8080
      - REVALIDATE_SECRET=local-secret
    networks:
      - brickers-local
    depends_on:
      - backend

networks:
  brickers-local:
    driver: bridge
