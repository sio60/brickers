services:
  backend:
    image: ${DOCKER_USERNAME}/brickers-backend:latest
    container_name: brickers-backend
    ports:
      - "${BACKEND_PORT}:8080"
    environment:
      # ‚úÖ ÏãúÍ∞ÑÎåÄ ÏÑ§Ï†ï (ÌïúÍµ≠)
      - TZ=Asia/Seoul
      # ‚úÖ MongoDB ÏÑ§Ï†ï
      - PRIMARY_MONGODB_URI=${PRIMARY_MONGODB_URI}

      # ‚úÖ AWS S3 ÏÑ§Ï†ï
      - AWS_S3_BUCKET=${AWS_S3_BUCKET}
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - UPLOAD_PROVIDER=${UPLOAD_PROVIDER:-S3}
      - UPLOAD_PUBLIC_BASE_URL=${UPLOAD_PUBLIC_BASE_URL}

      # ‚úÖ JWT ÏÑ§Ï†ï
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_EXPIRATION=${JWT_ACCESS_EXPIRATION}
      - JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION}

      # ‚úÖ OAuth ÏÑ§Ï†ï
      - KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
      - KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}
      - KAKAO_ADMIN_KEY=${KAKAO_ADMIN_KEY}

      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI}
      - GOOGLE_LOCAL_REDIRECT_URI=${GOOGLE_LOCAL_REDIRECT_URI}

      # ‚úÖ Ïπ¥Ïπ¥Ïò§ Î¶¨Îã§Ïù¥Î†âÌä∏ URI
      - KAKAO_REDIRECT_URI=${KAKAO_REDIRECT_URI}

      # ‚úÖ Ïø†ÌÇ§ ÏÑ§Ï†ï
      - COOKIE_SECURE=${COOKIE_SECURE:-true}
      - COOKIE_SAMESITE=${COOKIE_SAMESITE:-None}

      # ‚úÖ Base URL
      - FRONT_BASE_URL=${FRONT_BASE_URL}

      # ‚úÖ AI ÏÑúÎ≤Ñ URL
      - AI_SERVER_URL=${AI_SERVER_URL}

      # ‚úÖ OpenAI Key
      - APP_OPENAI_API_KEY=${APP_OPENAI_API_KEY}

      # ‚úÖ (Ï∂îÍ∞Ä) Kids AI Ï≤òÎ¶¨ ÌÉÄÏûÑÏïÑÏõÉ
      - PROCESS_TIMEOUT=900
      - DOWNLOAD_TIMEOUT=120

      # ‚úÖ SQS ÏÑ§Ï†ï (2Í∞ú Queue Î∂ÑÎ¶¨)
      - AWS_SQS_ENABLED=${AWS_SQS_ENABLED:-true}
      - AWS_SQS_REQUEST_QUEUE_URL=${AWS_SQS_REQUEST_QUEUE_URL}
      - AWS_SQS_RESULT_QUEUE_URL=${AWS_SQS_RESULT_QUEUE_URL}

      # ‚úÖ Gallery SEO Revalidate ÏÑ§Ï†ï
      - GALLERY_REVALIDATE_ENABLED=${GALLERY_REVALIDATE_ENABLED:-true}
      - GALLERY_REVALIDATE_URL=${GALLERY_REVALIDATE_URL:-http://frontend:3000/api/revalidate}
      - GALLERY_REVALIDATE_SECRET=${GALLERY_REVALIDATE_SECRET}

      # ‚úÖ Internal API Token (AI Server ‚Üí Backend Î°úÍ∑∏ Ï†ÑÏÜ° Ïù∏Ï¶ù)
      - INTERNAL_API_TOKEN=${INTERNAL_API_TOKEN}

      # ‚úÖ GA4 Data API Ïù∏Ï¶ù (Backend Ï†ÑÏö©)
      - GA4_PROPERTY_ID=${GA4_PROPERTY_ID}
      - GA4_CREDENTIALS_JSON=${GA4_CREDENTIALS_JSON}

    networks:
      - brickers-network

  # ‚úÖ AI Server (Brick Judge + Chatbot)
  ai-server:
    # üöÄ Docker Hub Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö© (Î∞∞Ìè¨ Ïãú ÏÜåÏä§ ÎπåÎìú Î∂àÌïÑÏöî)
    image: ${DOCKER_USERNAME}/brickers-ai:latest
    container_name: brickers-ai
    ports:
      - "8000:8000"
    environment:
      - TZ=Asia/Seoul
      - OPENAI_API_KEY=${APP_OPENAI_API_KEY}
      - TRIPO_API_KEY=${TRIPO_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - NANO_BANANA_MODEL=${NANO_BANANA_MODEL}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET}
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - S3_PREFIX=${S3_PREFIX}
    networks:
      - brickers-network

  # ‚úÖ ÌÜµÌï©Îêú Next.js Ïï± (Kids + Gallery Î™®Îëê Ìè¨Ìï®.)
  frontend:
    image: ${DOCKER_USERNAME}/brickers-frontend:latest
    container_name: brickers-frontend
    ports:
      - "${FRONTEND_PORT}:80"
      - "443:443"
      - "3000:3000"
    environment:
      # ‚úÖ ÏãúÍ∞ÑÎåÄ ÏÑ§Ï†ï (ÌïúÍµ≠)
      - TZ=Asia/Seoul
      # ‚úÖ Next.js ÌôòÍ≤ΩÎ≥ÄÏàò
      # NEXT_PUBLIC_*ÏùÄ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏(Î∏åÎùºÏö∞Ï†Ä)ÏóêÏÑú ÏÇ¨Ïö© ‚Üí Îπà Î¨∏ÏûêÏó¥Î°ú ÏÉÅÎåÄÍ≤ΩÎ°ú ÏÇ¨Ïö©
      - NEXT_PUBLIC_API_BASE_URL=
      - NEXT_PUBLIC_GA_ID=${NEXT_PUBLIC_GA_ID}
      - NEXT_PUBLIC_GTM_ID=${NEXT_PUBLIC_GTM_ID}
      # API_BASEÎäî ÏÑúÎ≤ÑÏÇ¨Ïù¥Îìú(SSR, rewrites)ÏóêÏÑú ÏÇ¨Ïö© ‚Üí Docker ÎÇ¥Î∂Ä ÎÑ§Ìä∏ÏõåÌÅ¨
      - API_BASE=http://backend:8080
      - REVALIDATE_SECRET=${GALLERY_REVALIDATE_SECRET}
    depends_on:
      - backend
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - brickers-network

networks:
  brickers-network:
    driver: bridge
