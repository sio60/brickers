services:
  backend:
    image: ${DOCKER_USERNAME}/brickers-backend:latest
    container_name: brickers-backend
    ports:
      - "${BACKEND_PORT:-8080}:8080"
    environment:
      # Mongo
      - MONGO_USER=${MONGO_USER}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
      - MONGO_HOST=${MONGO_HOST}
      - MONGO_PORT=${MONGO_PORT:-27017}
      - MONGO_DB_NAME=${MONGO_DB_NAME}

      # ✅ OAuth (Spring yml에서 이 변수명 그대로 쓰는지 꼭 확인)
      - KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
      - KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}

      # ✅ 배포 도메인 기준(핵심)
      - FRONT_BASE_URL=${FRONT_BASE_URL:-https://brickers.shop}
      - LOCAL_BASE_URL=${LOCAL_BASE_URL:-https://brickers.shop}

      # JWT (있으면)
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_EXPIRATION=${JWT_ACCESS_EXPIRATION:-3600000}
      - JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION:-604800000}

      # ✅ 리버스프록시(nginx) 뒤에서 https 인식용(권장)
      - SERVER_FORWARD_HEADERS_STRATEGY=framework

    depends_on:
      - mongodb
    networks:
      - brickers-network

  frontend:
    image: ${DOCKER_USERNAME}/brickers-frontend:latest
    container_name: brickers-frontend
    ports:
      - "${FRONTEND_PORT:-80}:80"
      - "443:443"
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - backend
      - ai
    networks:
      - brickers-network

  ai:
    image: ${DOCKER_USERNAME}/brickers-ai:latest
    container_name: brickers-ai
    ports:
      - "${AI_PORT:-8000}:8000"
    environment:
      - MONGO_URI=${AI_MONGODB_URI}
      - MONGO_DB_NAME=${AI_MONGODB_NAME}
      - AI_PARTS_COLLECTION=${AI_PARTS_COLLECTION}
      - AI_VECTOR_INDEX=${AI_VECTOR_INDEX}
      - AI_VECTOR_FIELD=${AI_VECTOR_FIELD}
      - AI_EMBEDDING_DIMS=${AI_EMBEDDING_DIMS}
    networks:
      - brickers-network

  mongodb:
    image: mongo:latest
    container_name: brickers-mongodb
    ports:
      - "${MONGO_PORT:-27017}:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD}
    volumes:
      - mongodb_data:/data/db
    networks:
      - brickers-network

networks:
  brickers-network:
    driver: bridge

volumes:
  mongodb_data:
