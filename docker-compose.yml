version: '3.8'

services:
  backend:
    image: ${DOCKER_USERNAME}/brickers-backend:latest
    container_name: brickers-backend
    ports:
      - "${BACKEND_PORT}:8080"
    environment:
      # ✅ MongoDB 설정
      - PRIMARY_MONGODB_URI=${PRIMARY_MONGODB_URI}
      
      # ✅ [추가] AWS S3 설정 (이게 없으면 업로드 안 됨)
      - AWS_S3_BUCKET=${AWS_S3_BUCKET}
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - UPLOAD_PROVIDER=${UPLOAD_PROVIDER:-S3}
      - UPLOAD_PUBLIC_BASE_URL=${UPLOAD_PUBLIC_BASE_URL}
      
      # ✅ [추가] JWT 설정 (이게 없으면 로그인 안 됨)
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_EXPIRATION=${JWT_ACCESS_EXPIRATION}
      - JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION}
      
      # ✅ OAuth 설정 (빠진 것들 추가)
      - KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
      - KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET} 
      - KAKAO_ADMIN_KEY=${KAKAO_ADMIN_KEY}
      
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI}
      - GOOGLE_LOCAL_REDIRECT_URI=${GOOGLE_LOCAL_REDIRECT_URI}
      
      # ✅ 카카오 리다이렉트 URI (배포용)
      - KAKAO_REDIRECT_URI=${KAKAO_REDIRECT_URI}
      
      # ✅ 쿠키 설정 (크로스 도메인 필수!)
      - COOKIE_SECURE=${COOKIE_SECURE:-true}
      - COOKIE_SAMESITE=${COOKIE_SAMESITE:-None}
      
      # ✅ Base URL (CORS/리다이렉트용)
      - FRONT_BASE_URL=${FRONT_BASE_URL}
      
      # ✅ AI 서버 URL (Python FastAPI)
      - AI_SERVER_URL=${AI_SERVER_URL}
      
      # ✅ OpenAI Key (추가됨)
      - APP_OPENAI_API_KEY=${APP_OPENAI_API_KEY}

    networks:
      - brickers-network

  frontend:
    image: ${DOCKER_USERNAME}/brickers-frontend:latest
    container_name: brickers-frontend
    ports:
      - "${FRONTEND_PORT}:80"
    depends_on:
      - backend
    # 프론트엔드는 빌드할 때 이미 변수가 구워져서 나오므로 environment 불필요
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt
    networks:
      - brickers-network

networks:
  brickers-network:
    driver: bridge
